<!DOCTYPE html>
<html lang="en">
<head>
  <link href="global.css" rel="stylesheet">
  <meta charset="UTF-8">
  <title>Switchee Troubleshooting Builder</title>
  <!-- PWA: Manifest & Theme -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="icon" href="leaf.png">

  <!-- PWA: Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('SW registered', reg))
          .catch(err => console.error('SW registration failed', err));
      });
    }
  </script>

  
</head>
<body>

  <header class="site-header">
    <img src="leaf.png" alt="Leaf Logo" class="site-logo">
    <h1 class="site-title">Switchee Troubleshooting Builder</h1>
  </header>

  <div class="back-menu">
    <a href="index.html">&larr; Back to Main Menu</a>
  </div>

  <div class="container">
    <!-- Create / Edit Section -->
    <section>
      <h2>Create or Edit Situation</h2>
      <label for="editSelect">Select Situation to Edit (or leave blank to create new):</label>
      <select id="editSelect"><option value="">-- New Situation --</option></select>

      <label for="title">Situation Title:</label>
      <input id="title" placeholder="e.g., Situation 7: Thermostat offline">

      <div id="steps"></div>

      <button id="previewBtn">Preview Situation</button>
      <button id="downloadBtn" style="display:none;">Download Situation Page</button>

      <div id="linkContainer" style="display:none;">
        <label for="linkSnippet">Copy this link into index.html:</label>
        <textarea id="linkSnippet" readonly></textarea>
      </div>

      <iframe id="previewFrame"></iframe>
    </section>

    <!-- Delete Existing Section -->
    <section>
      <h2>Delete Existing Situation</h2>
      <label for="deleteSelect">Select Situation to Delete:</label>
      <select id="deleteSelect"><option value="">-- Choose --</option></select>
      <button id="deleteBtn">Generate Delete Instructions</button>
      <pre id="deleteInstructions" style="margin-top:20px;"></pre>
    </section>
  </div>

  <div class="back-menu">
    <a href="index.html">&larr; Back to Main Menu</a>
  </div>

  <script>
    // Utility to fetch current index.html menu links
    async function loadPages() {
      const resp = await fetch('index.html');
      const doc = new DOMParser().parseFromString(await resp.text(), 'text/html');
      const pages = {};
      doc.querySelectorAll('.menu a').forEach(a => {
        const href = a.getAttribute('href');
        pages[href] = a.textContent.trim();
      });
      return pages;
    }

    (async function(){
      // Load dynamic pages list
      const pages = await loadPages();
      const editSelect   = document.getElementById('editSelect');
      const deleteSelect = document.getElementById('deleteSelect');

      // Populate both dropdowns
      for (const [file, label] of Object.entries(pages)) {
        editSelect.insertAdjacentHTML('beforeend',
          `<option value="${file}">${label}</option>`);
        deleteSelect.insertAdjacentHTML('beforeend',
          `<option value="${file}">${label}</option>`);
      }

      // Inject step/detail/image inputs
      const stepsContainer = document.getElementById('steps');
      for (let i=1; i<=5; i++) {
        stepsContainer.insertAdjacentHTML('beforeend', `
          <label for="step${i}">Step ${i}:</label>
          <input id="step${i}" placeholder="Step ${i} description...">
          <label for="detail${i}">Detail ${i}:</label>
          <textarea id="detail${i}" rows="2" placeholder="Detail for step ${i}..."></textarea>
          <label for="img${i}">Choose Image (optional):</label>
          <input id="img${i}" type="file" accept="image/*">
        `);
      }

      // Prefill for editing
      editSelect.onchange = async () => {
        const file = editSelect.value;
        if (!file) {
          document.getElementById('title').value = '';
          for (let i=1; i<=5; i++) {
            document.getElementById(`step${i}`).value = '';
            document.getElementById(`detail${i}`).value = '';
            document.getElementById(`img${i}`).value = '';
          }
          return;
        }
        const resp = await fetch(file);
        const doc  = new DOMParser().parseFromString(await resp.text(),'text/html');
        document.getElementById('title').value = doc.querySelector('h1').textContent.trim();
        for (let i=1; i<=5; i++) {
          const stepEl   = doc.querySelector(`.flow a[href="#section${i}"]`);
          const detailEl = doc.querySelector(`#section${i} p`);
          document.getElementById(`step${i}`).value   = stepEl   ? stepEl.textContent.trim() : '';
          document.getElementById(`detail${i}`).value = detailEl ? detailEl.textContent.trim() : '';
        }
      };

      // Build HTML (with images)
      async function buildHTML() {
        const title = document.getElementById('title').value || 'New Situation';
        let html = `<!DOCTYPE html>
<html lang="en"><head>
  <link href="global.css" rel="stylesheet"><meta charset="UTF-8"><title>${title}</title>
</head><body>
<header class="site-header"><img src="leaf.png" class="site-logo" alt="Leaf Logo">
<h1 class="site-title">${title}</h1></header>
<div class="back-menu"><a href="index.html">← Back to Main Menu</a></div>
<div class="flow">`;
        for (let i=1; i<=5; i++) {
          const txt = document.getElementById(`step${i}`).value || `Step ${i}`;
          html += `<a href="#section${i}">${txt}</a>`;
        }
        html += `</div>`;
        for (let i=1; i<=5; i++) {
          const detail = document.getElementById(`detail${i}`).value || '';
          html += `<section id="section${i}"><h2>Step ${i}</h2><p>${detail}</p>`;
          const input = document.getElementById(`img${i}`);
          if (input.files.length) {
            const dataURL = await new Promise(res=>{
              const r=new FileReader();
              r.onload=e=>res(e.target.result);
              r.readAsDataURL(input.files[0]);
            });
            html += `<img src="${dataURL}" alt="Step ${i} Image" class="step-image">`;
          }
          html += `</section>`;
        }
        html += `<div class="back-menu"><a href="index.html">← Back to Main Menu</a></div>
</body></html>`;
        return html;
      }

      // Preview & Download
      document.getElementById('previewBtn').onclick = async ()=>{
        const content = await buildHTML();
        const blob    = new Blob([content],{type:'text/html'});
        const url     = URL.createObjectURL(blob);
        document.getElementById('previewFrame').src = url;
        const dlBtn   = document.getElementById('downloadBtn');
        dlBtn.style.display = 'inline-block';
        document.getElementById('linkContainer').style.display = 'none';

        dlBtn.onclick = () => {
          const a = document.createElement('a');
          a.href = url;
          const filename = (document.getElementById('title').value||'new-situation')
                             .toLowerCase().replace(/\s+/g,'-') + '.html';
          a.download = filename;
          a.click();

          // Auto-add new page to selects
          const label = document.getElementById('title').value;
          if (!pages[filename]) {
            pages[filename] = label;
            const opt  = `<option value="${filename}">${label}</option>`;
            editSelect.insertAdjacentHTML('beforeend', opt);
            deleteSelect.insertAdjacentHTML('beforeend', opt);
          }

          // Show copy-paste snippet
          document.getElementById('linkSnippet').value = `<a href="${filename}">${label}</a>`;
          document.getElementById('linkContainer').style.display = 'block';
        };
      };

      // Delete instructions
      document.getElementById('deleteBtn').onclick = ()=>{
        const file = deleteSelect.value;
        if (!file) {
          document.getElementById('deleteInstructions').textContent = 'Please select a situation to delete.';
          return;
        }
        document.getElementById('deleteInstructions').textContent =
          `1) Delete the file "${file}".\n` +
          `2) Remove this line from index.html:\n` +
          `<li><a href="${file}">${pages[file]}</a></li>`;
      };
    })();
  </script>
</body>
</html>
